name: CI/CD Pipeline

on:
  # CI runs AFTER auto-format workflow completes successfully
  # This ensures we always check the formatted code (or original if no changes)
  workflow_run:
    workflows: ["Auto Format Code"]
    types:
      - completed
    branches:
      - '**'  # Run for all branches

jobs:
  # Job 1: Lint first (fastest, cheapest)
  lint:
    # Only run if auto-format succeeded (whether it made changes or not)
    if: github.event.workflow_run.conclusion == 'success'
    
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Check out the branch that triggered auto-format
        # This gets the latest commit (formatted or original)
        ref: ${{ github.event.workflow_run.head_branch }}
    
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-3.13-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      run: poetry install --no-interaction --with dev
    
    - name: Run code formatting checks
      run: |
        poetry run black --check src/ tests/
        poetry run isort --check-only src/ tests/
    
    - name: Run flake8 linting
      run: poetry run flake8 src/ tests/
    
    - name: Run mypy type checking
      run: poetry run mypy src/ --ignore-missing-imports

  # Job 2: Test (run after lint passes)
  test:
    needs: lint
    if: github.event.workflow_run.conclusion == 'success'
    
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.13"]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.head_branch }}
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      run: poetry install --no-interaction --with dev
    
    - name: Install GDAL system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gdal-bin libgdal-dev
    
    - name: Run tests with coverage
      run: |
        poetry run pytest tests/ -v --cov=src/agri_toolkit --cov-report=xml --cov-report=term
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # Job 3: Build (only if lint and test pass)
  build:
    needs: [lint, test]
    if: github.event.workflow_run.conclusion == 'success'
    
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.head_branch }}
    
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
    
    - name: Build package
      run: poetry build
    
    # Determine if this is a pull request by checking the head branch
    - name: Check if PR context
      id: pr-check
      run: |
        # Get PR number if this branch has an open PR
        PR_NUMBER=$(gh pr list --head ${{ github.event.workflow_run.head_branch }} --json number --jq '.[0].number')
        if [ -n "$PR_NUMBER" ]; then
          echo "is_pr=true" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        else
          echo "is_pr=false" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # Only upload artifacts if this is a PR with 'generate-build-artifact' label
    - name: Check for artifact label
      if: steps.pr-check.outputs.is_pr == 'true'
      id: check-label
      run: |
        LABELS=$(gh pr view ${{ steps.pr-check.outputs.pr_number }} --json labels --jq '.labels[].name')
        if echo "$LABELS" | grep -q "generate-build-artifact"; then
          echo "should_upload=true" >> $GITHUB_OUTPUT
        else
          echo "should_upload=false" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Store build artifacts
      if: steps.pr-check.outputs.is_pr == 'true' && steps.check-label.outputs.should_upload == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages
        path: dist/
        retention-days: 7
    
    - name: Build summary
      run: |
        echo "‚úÖ Build completed successfully"
        if [ "${{ steps.pr-check.outputs.is_pr }}" == "true" ]; then
          if [ "${{ steps.check-label.outputs.should_upload }}" == "true" ]; then
            echo "üì¶ Artifacts uploaded (generate-build-artifact label present)"
          else
            echo "‚ÑπÔ∏è  Artifacts not stored (add 'generate-build-artifact' label to store)"
          fi
        fi
